<div class="page-container">
  <header class="page-header">
    <h1>Gestión de Roles</h1>
    <button class="btn btn-primary" (click)="showCreateForm.set(!showCreateForm())">
      {{ showCreateForm() ? 'Cancelar' : 'Nuevo Rol' }}
    </button>
  </header>

  <!-- Formulario de creación/edición -->
 @if(showCreateForm()){
  <div class="form-section">
    <h2>{{ editingRole() ? 'Editar Rol' : 'Crear Nuevo Rol' }}</h2>
    <form [formGroup]="roleForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="name">Nombre del Rol:</label>
        <input
          type="text"
          id="name"
          formControlName="name"
          class="form-control"
          [class.error]="name?.invalid && name?.touched"
        >
       @if(name?.invalid && name?.touched){
        <div  class="error-message">
          @if(name?.errors?.['required']){
            <span>El nombre es requerido</span>
          }
          @if(name?.errors?.['minlength']){
            <span>El nombre debe tener al menos 2 caracteres</span>
          }
        </div>
       }
      </div>

      <div class="form-group">
        <label for="description">Descripción:</label>
        <textarea
          id="description"
          formControlName="description"
          rows="3"
          class="form-control"
          [class.error]="description?.invalid && description?.touched"
        ></textarea>
        @if(description?.invalid && description?.touched){
          <div class="error-message">
            @if(description?.errors?.['required']){
              <span>La descripción es requerida</span>
            }
            @if(description?.errors?.['minlength']){
              <span>La descripción debe tener al menos 10 caracteres</span>
            }
          </div>
        }
      </div>

      <div class="form-group">
        <label>Permisos:</label>
        <div class="permissions-grid" formArrayName="permissions">
          @for(permission of availablePermissions; track permission.key; let i = $index){
            <label class="permission-checkbox">
              <input
                type="checkbox"
                [formControlName]="i"
                (change)="onPermissionChange(i, $event)"
              >
              <span>{{ permission.label }}</span>
            </label>
          }
        </div>
      </div>

    @if(formErrorMessage()){
      <div class="alert alert-error">
        {{ formErrorMessage() }}
      </div>
    }

      <div class="form-actions">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="roleForm.invalid || isLoading()"
        >
          {{ isLoading() ? 'Guardando...' : (editingRole() ? 'Actualizar' : 'Crear') }}
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="cancelEdit()"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
 }

  <!-- Lista de roles -->
  <div class="roles-section">
    <h2>Roles Registrados</h2>

    @if(isLoadingRoles()){
      <div  class="loading">
        Cargando roles...
      </div>
    }
  @if(!isLoadingRoles() && roles().length === 0){
    <div class="empty-state">
      No hay roles registrados
    </div>
  }
   @if(!isLoadingRoles() && roles().length > 0){
    <div class="roles-grid">
      @for(role of roles(); track role.id){
        <div class="role-card">
          <div class="role-info">
            <h3>{{ role.name }}</h3>
            <p class="role-description">{{ role.description }}</p>
            <div class="role-permissions">
              <h4>Permisos:</h4>
              <div class="permissions-list">
                @for(permission of role.permissions; track permission){
                  <span
                  class="permission-tag"
                >
                  {{ getPermissionLabel(permission) }}
                </span>
                }
               @if(role.permissions.length === 0){
                <span  class="no-permissions">
                  Sin permisos asignados
                </span>
               }
              </div>
            </div>
            <p class="role-status">
              <span class="status-badge" [class.active]="role.isActive">
                {{ role.isActive ? 'Activo' : 'Inactivo' }}
              </span>
            </p>
            <p class="role-date">
              Creado: {{ role.createdAt | date:'dd/MM/yyyy' }}
            </p>
          </div>
          <div class="role-actions">
            <button
              class="btn btn-sm btn-secondary"
              (click)="editRole(role)"
            >
              Editar
            </button>
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteRole(role.id.value)"
              [disabled]="isDeleting() === role.id.value"
            >
              {{ isDeleting() === role.id.value ? 'Eliminando...' : 'Eliminar' }}
            </button>
          </div>
        </div>
      }
    </div>
   }
  </div>
</div>
