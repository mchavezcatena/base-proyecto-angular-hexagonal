<div class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal-container" (click)="onModalClick($event)">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="header-content">
        <h2>Asignar Roles</h2>
        <div class="user-info">
          <div class="user-avatar">
            <span>{{ user.name.charAt(0).toUpperCase() }}</span>
          </div>
          <div class="user-details">
            <h3>{{ user.name }}</h3>
            <p>{{ user.email.value }}</p>
          </div>
        </div>
      </div>
      <button class="close-button" (click)="onCancel()" type="button">
        <span>‚úï</span>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Error Message -->
     @if (error()) {
      <div class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{ error() }}
      </div>
     }

      <!-- Roles Selection -->
      <div class="roles-section">
        <div class="section-header">
          <h4>Seleccionar Roles</h4>
          <div class="selection-info">
            <span class="selected-count">{{ selectedRolesCount() }} seleccionados</span>
            @if (hasChanges()) {
              <span class="changes-count">{{ roleChangesCount() }} cambios</span>
            }
          </div>
        </div>

        @if (availableRoles().length === 0) {
          <div class="no-roles-message">
          <div class="no-roles-icon">üîí</div>
          <p>No hay roles disponibles para asignar</p>
          </div>
        }

        @if (availableRoles().length > 0) {
          <div class="roles-grid">
            @for (role of availableRoles(); track role.id) {
              <div
            class="role-item"
            [class.selected]="isRoleSelected(role.id.value)"
            [class.currently-assigned]="isRoleCurrentlyAssigned(role.id.value)">

            <div class="role-checkbox">
              <input
                type="checkbox"
                [id]="'role-' + role.id.value"
                [checked]="isRoleSelected(role.id.value)"
                (change)="onRoleSelectionChange(role.id.value, $any($event.target).checked)">
              <label [for]="'role-' + role.id.value" class="checkbox-label"></label>
            </div>

            <div class="role-info">
              <div class="role-header">
                <h5>{{ role.name }}</h5>
                <div class="role-badges">
                  @if (isRoleCurrentlyAssigned(role.id.value)) {
                    <span
                    class="badge current-badge">
                    class="badge current-badge">
                    Actual
                  </span>
                  }
                  @if (role.permissions.length > 0) {
                    <span
                    class="badge permissions-badge">
                    {{ role.permissions.length }} permisos
                  </span>
                  }
                </div>
              </div>

              <p class="role-description">{{ role.description || 'Sin descripci√≥n' }}</p>

              @if(role.permissions.length > 0){
                <div class="role-permissions">
                  <span class="permissions-label">Permisos:</span>
                  <div class="permissions-list">
                   @for (permission of role.permissions.slice(0, 3); track permission) {
                    <span
                      class="permission-tag">
                      {{ permission }}
                    </span>
                   }
                    @if(role.permissions.length > 3){
                      <span
                      class="permission-tag more">
                      +{{ role.permissions.length - 3 }} m√°s
                    </span>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
            }
          </div>
        }
      </div>

      <!-- Selection Summary -->
      @if(selectedRolesCount() > 0){
        <div class="selection-summary">
          <h5>Resumen de Asignaci√≥n</h5>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">Roles seleccionados:</span>
              <span class="summary-value">{{ selectedRolesCount() }}</span>
            </div>
            @if(hasChanges()){
              <div class="summary-item">
                <span class="summary-label">Cambios a realizar:</span>
                <span class="summary-value">{{ roleChangesCount() }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button
        class="cancel-button"
        (click)="onCancel()"
        type="button"
        [disabled]="loading()">
        Cancelar
      </button>

      <button
        class="assign-button"
        (click)="onAssignRoles()"
        type="button"
        [disabled]="loading() || selectedRolesCount() === 0">
        @if(!loading()){
        <span>
            {{ hasChanges() ? 'Guardar Cambios' : 'Asignar Roles' }}
          </span>
        }
        @if(loading()){
          <span class="loading-spinner"></span>
          Asignando...
        }
      </button>
    </div>
  </div>
</div>
